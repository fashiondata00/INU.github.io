<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>오픈 채팅방</title>
  <style>
    body { font-family: sans-serif; margin:0; background:#f6f7f9; }
    .wrap { max-width:720px; margin:20px auto; padding:0 16px; }
    .card { background:#fff; border:1px solid #ddd; border-radius:12px; overflow:hidden; }
    header { padding:12px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; }
    #messages { height:60vh; overflow-y:auto; padding:16px; }
    .msg { margin:10px 0; }
    .msg .meta { font-size:12px; color:#666; margin-bottom:4px; }
    .msg .bubble { display:inline-block; background:#f3f4f6; padding:10px; border-radius:8px; }
    .me .bubble { background:#eef2ff; }
    form { display:flex; gap:8px; padding:12px; border-top:1px solid #eee; }
    input, button { padding:10px; border:1px solid #ccc; border-radius:6px; }
    input { flex:1; }
    button { background:#111827; color:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h3>오픈 채팅방</h3>
        <div id="presence">접속자 0명</div>
      </header>
      <div style="padding:8px;">
        <input id="name" placeholder="닉네임" />
        <button id="saveName">닉네임 저장</button>
      </div>
      <div id="messages"></div>
      <form id="chatForm">
        <input id="text" placeholder="메시지를 입력하세요…" />
        <button type="submit">전송</button>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Firebase 설정 (사용자님 프로젝트 값 반영)
    const firebaseConfig = {
      apiKey: "AIzaSyB3Vf5qeWKdWPFrBddnEczXdtzv2Iw8peQ",
      authDomain: "marketing-1e96e.firebaseapp.com",
      databaseURL: "https://marketing-1e96e-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "marketing-1e96e",
      storageBucket: "marketing-1e96e.firebasestorage.app",
      messagingSenderId: "882227172037",
      appId: "1:882227172037:web:6d4a002d7a68c7858896ac"
    };

    // SDK 불러오기
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getDatabase, ref, onValue, onDisconnect, serverTimestamp as rtdbTs, set, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // 초기화
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);

    const ROOM_ID = "open-room-1";
    const messagesRef = collection(db, `rooms/${ROOM_ID}/messages`);

    const $messages = document.getElementById("messages");
    const $form = document.getElementById("chatForm");
    const $text = document.getElementById("text");
    const $name = document.getElementById("name");
    const $saveName = document.getElementById("saveName");
    const $presence = document.getElementById("presence");

    let currentUid = null;

    // 익명 로그인
    signInAnonymously(auth);
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUid = user.uid;
        const meRef = ref(rtdb, `presence/${ROOM_ID}/${currentUid}`);
        set(meRef, { online:true, ts:rtdbTs() });
        onDisconnect(meRef).remove();
      }
    });

    // 접속자 수 표시
    const presenceRef = ref(rtdb, `presence/${ROOM_ID}`);
    onValue(presenceRef, (snap) => {
      const val = snap.val() || {};
      $presence.textContent = `접속자 ${Object.keys(val).length}명`;
    });

    // 닉네임 저장
    $saveName.addEventListener("click", async () => {
      if (auth.currentUser) {
        await updateProfile(auth.currentUser, { displayName: $name.value || "익명" });
        alert("닉네임 저장 완료!");
      }
    });

    // 메시지 수신
    const q = query(messagesRef, orderBy("ts","desc"), limit(100));
    onSnapshot(q, (snap) => {
      const arr = [];
      snap.forEach(doc => {
        const m = doc.data();
        const isMe = m.uid === currentUid;
        const time = m.ts?.toDate?.().toLocaleString() || "";
        arr.push(`<div class="msg ${isMe?'me':''}"><div class="meta">${m.name} · ${time}</div><div class="bubble">${m.text}</div></div>`);
      });
      $messages.innerHTML = arr.reverse().join("");
      $messages.scrollTop = $messages.scrollHeight;
    });

    // 메시지 전송
    $form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = $text.value.trim();
      if (!text) return;
      await addDoc(messagesRef, {
        uid: currentUid,
        name: $name.value || "익명",
        text,
        ts: serverTimestamp()
      });
      $text.value = "";
    });
  </script>
</body>
</html>
