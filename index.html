<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Data marketing (Made by. Fashiondata00 Lab)</title>
  <style>
    :root{
      --bg:#fef7f0;
      --card:#ffffff;
      --text:#1a1a1a;
      --muted:#666666;
      --border:#ffe4d1;
      --primary:#ff6600;
      --primary-light:#ff8533;
      --primary-dark:#e55a00;
      --primary-2:#ff9966;
      --bubble:#ffffff;
      --bubble-me:#ff6600;
      --bubble-text:#1a1a1a;
      --bubble-me-text:#ffffff;
      --chip:#fff5f0;
      --shadow:0 8px 30px rgba(255,102,0,.15);
      --glass:rgba(255,255,255,.85);
      --accent:#ffcc99;
      --success:#10b981;
      --hover:#fff0e6;
    }
    [data-theme="dark"]{
      --bg:#1a0f0a;
      --card:#2a1f1a;
      --text:#f0f0f0;
      --muted:#b3b3b3;
      --border:#3d2b1f;
      --primary:#ff7a1a;
      --primary-light:#ff9444;
      --primary-dark:#e5690f;
      --primary-2:#ff9966;
      --bubble:#2a1f1a;
      --bubble-me:#ff6600;
      --bubble-text:#f0f0f0;
      --bubble-me-text:#ffffff;
      --chip:#2d1f14;
      --shadow:0 8px 30px rgba(255,102,0,.25);
      --glass:rgba(255,255,255,.15);
      --accent:#ff9966;
      --success:#10b981;
      --hover:#332117;
    }

    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg);min-height:100vh;padding:20px;color:var(--text);}

    .wrap{max-width:900px;margin:0 auto;animation:fadeIn .5s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)}}

    .card{background:var(--card);border-radius:20px;overflow:hidden;box-shadow:var(--shadow);height:85vh;display:flex;flex-direction:column;border:1px solid var(--border);}

    header{
      position:relative;
      background:linear-gradient(135deg,var(--primary) 0%,var(--primary-2) 100%);
      color:#fff;padding:18px 20px;display:flex;justify-content:space-between;align-items:center;
    }
    header h3{font-size:1.25rem;font-weight:700;letter-spacing:.2px;display:flex;gap:10px;align-items:center}
    .presence{
      display:flex;gap:10px;align-items:center;background:var(--glass);
      padding:8px 14px;border-radius:999px;backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.35);
      font-weight:600;
    }
    .presence .dot{width:10px;height:10px;border-radius:50%;background:var(--success);box-shadow:0 0 0 0 rgba(16,185,129,.7);animation:ping 1.8s infinite}
    @keyframes ping{0%{box-shadow:0 0 0 0 rgba(16,185,129,.6)}70%{box-shadow:0 0 0 8px rgba(16,185,129,0)}100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}}

    .toolbar{display:flex;gap:8px;align-items:center}
    .btn{
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
      padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.25);
      background:var(--glass);color:#fff;cursor:pointer;transition:all .2s ease;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.95);color:var(--primary)}
    .btn-ghost{background:transparent;border-color:rgba(255,255,255,.35)}
    .btn svg{pointer-events:none}

    .user-section{padding:14px 16px;background:var(--hover);border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    #name{flex:1;min-width:200px;padding:10px 14px;border:1px solid var(--border);border-radius:10px;font-size:15px;background:var(--card);color:var(--text);transition:all .2s ease}
    #name:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(255,102,0,.2)}
    #saveName{padding:10px 16px;background:var(--primary);color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;transition:all .2s ease}
    #saveName:hover{background:var(--primary-light);transform:translateY(-1px)}
    #saveName:active{background:var(--primary-dark);transform:translateY(0)}
    #saveName:disabled{opacity:.6;cursor:not-allowed}

    #messages{flex:1;overflow-y:auto;padding:18px;scroll-behavior:smooth;background:
      radial-gradient(1200px 300px at 100% 0%, rgba(255,102,0,.08), transparent 60%),
      radial-gradient(800px 200px at 0% 100%, rgba(255,153,102,.06), transparent 60%);}
    #messages::-webkit-scrollbar{width:8px}
    #messages::-webkit-scrollbar-thumb{background:var(--accent);border-radius:999px}
    #messages::-webkit-scrollbar-track{background:var(--chip)}

    .msg{margin:10px 0;display:flex;gap:10px}
    .msg.me{justify-content:flex-end}
    .avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--primary-2));display:flex;align-items:center;justify-content:center;color:#fff;font-size:.8rem;font-weight:700;flex:0 0 auto}
    .msg.me .avatar{background:linear-gradient(135deg,var(--primary-dark),var(--primary))}

    .msg-content{max-width:70%}
    .meta{font-size:12px;color:var(--muted);margin:0 6px 6px}
    .bubble{background:var(--bubble);color:var(--bubble-text);padding:12px 14px;border-radius:16px;border:1px solid var(--border);box-shadow:0 2px 8px rgba(255,102,0,.1);transition:all .2s ease}
    .msg.me .bubble{background:var(--bubble-me);color:var(--bubble-me-text);border:none;box-shadow:0 2px 12px rgba(255,102,0,.25)}
    .bubble a{color:var(--primary);text-decoration:underline;word-break:break-all}
    .msg.me .bubble a{color:rgba(255,255,255,.9)}

    .file-card{display:flex;align-items:center;gap:10px}
    .file-icon{flex:0 0 auto;width:20px;height:20px;color:var(--primary)}
    .msg.me .file-icon{color:rgba(255,255,255,.9)}
    .muted{color:var(--muted)}
    .file-actions{margin-top:6px;font-size:12px}
    .file-link{color:var(--primary);font-weight:600;text-decoration:none;transition:color .2s ease}
    .file-link:hover{color:var(--primary-light)}
    .msg.me .file-link{color:rgba(255,255,255,.9)}
    .msg.me .file-link:hover{color:#fff}

    .chat-form{padding:12px 14px;background:var(--card);border-top:1px solid var(--border);display:flex;gap:10px;align-items:center}
    .icon-btn{width:40px;height:40px;border-radius:12px;border:1px solid var(--border);background:var(--chip);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s ease;color:var(--primary)}
    .icon-btn:hover{transform:translateY(-1px);background:var(--primary);color:#fff;border-color:var(--primary)}
    #text{flex:1;padding:12px 16px;border:1px solid var(--border);border-radius:14px;font-size:15px;background:var(--chip);color:var(--text);transition:all .2s ease}
    #text:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(255,102,0,.15);background:var(--card)}
    .send-button{padding:12px 18px;background:var(--primary);color:#fff;border:none;border-radius:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .2s ease}
    .send-button:hover{background:var(--primary-light);transform:translateY(-1px)}
    .send-button:active{background:var(--primary-dark);transform:translateY(0)}
    .send-button:disabled{opacity:.5;cursor:not-allowed;background:var(--muted)}

    .error-message{background:var(--hover);color:var(--primary-dark);padding:12px 16px;border-radius:10px;margin:10px 16px;display:none;border:1px solid var(--accent);font-size:14px}

    /* Drop zone */
    .drop-zone{position:absolute;inset:0;display:none;align-items:center;justify-content:center;pointer-events:none}
    .drop-zone.show{display:flex}
    .drop-surface{pointer-events:auto;border:2px dashed var(--primary);border-radius:16px;background:rgba(255,102,0,.08);padding:24px 28px;color:var(--text);backdrop-filter:blur(6px)}
    .drop-surface strong{color:var(--primary)}

    /* Ï∂îÍ∞Ä Ïä§ÌÉÄÏùºÎßÅ */
    .btn.file-attach{background:var(--chip);color:var(--primary);border:1px solid var(--border)}
    .btn.file-attach:hover{background:var(--primary);color:#fff;border-color:var(--primary)}

    @media (max-width:640px){
      .card{height:92vh;border-radius:14px}
      .msg-content{max-width:85%}
      header h3{font-size:1.05rem}
      .toolbar .btn span{display:none}
    }
  </style>
</head>
<body>
  <!-- Drag & Drop Overlay -->
  <div class="drop-zone" id="dropZone" aria-hidden="true">
    <div class="drop-surface">
      <div>Ïó¨Í∏∞Ïóê ÌååÏùºÏùÑ <strong>ÎÅåÏñ¥Îã§ ÎÜìÏúºÎ©¥</strong> ÏóÖÎ°úÎìúÎê©ÎãàÎã§ üìé</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <header>
        <h3>
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity:.95">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h11a2 2 0 0 1 2 2v2"></path>
            <path d="M14 10h7m-3.5-3.5V13"></path>
          </svg>
          Ïò§Ìîà Ï±ÑÌåÖÎ∞©
        </h3>
        <div class="toolbar">
          <div class="presence" id="presence">
            <span class="dot"></span>
            <span id="presenceText">Ï†ëÏÜçÏûê 0Î™Ö</span>
          </div>
          <button class="btn btn-ghost" id="themeToggle" title="Îã§ÌÅ¨Î™®Îìú Ï†ÑÌôò">
            <svg id="sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2m0 16v2m10-10h-2M4 12H2m15.364-7.364-1.414 1.414M8.05 16.95l-1.414 1.414m12.728 0-1.414-1.414M8.05 7.05 6.636 5.636"/></svg>
            <svg id="moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="display:none"><path d="M21 12.79A9 9 0 1 1 11.21 3A7 7 0 0 0 21 12.79z"/></svg>
            <span>Theme</span>
          </button>
        </div>
      </header>

      <div class="user-section">
        <input id="name" placeholder="ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="20" />
        <button id="saveName">Ï†ÄÏû•</button>
        <!-- Ïà®Í≤®ÏßÑ ÌååÏùº ÏûÖÎ†• + Î≤ÑÌäº -->
        <input id="file" type="file" accept=".xlsx,.xls,.doc,.docx,.pdf,.csv,.py,.html,.htm,.txt" style="display:none" />
        <button class="btn file-attach" id="attachBtn" type="button" title="ÌååÏùº Ï≤®Î∂Ä">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21.44 11.05 12 20.5a6 6 0 1 1-8.49-8.49l9.19-9.19a4 4 0 1 1 5.66 5.66L8.5 18"/></svg>
          <span>ÌååÏùº Ï≤®Î∂Ä</span>
        </button>
      </div>

      <div class="error-message" id="errorMessage"></div>
      <div id="messages" aria-live="polite"></div>

      <form class="chat-form" id="chatForm">
        <button class="icon-btn" id="attachBtn2" type="button" title="ÌååÏùº Ï≤®Î∂Ä">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21.44 11.05 12 20.5a6 6 0 1 1-8.49-8.49l9.19-9.19a4 4 0 1 1 5.66 5.66L8.5 18"/></svg>
        </button>
        <input id="text" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." maxlength="500" autocomplete="off" />
        <button type="submit" class="send-button" id="sendButton">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          Ï†ÑÏÜ°
        </button>
      </form>
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    // ===== Firebase ÏÑ§Ï†ï =====
    const firebaseConfig = {
      apiKey: "AIzaSyB3Vf5qeWKdWPFrBddnEczXdtzv2Iw8peQ",
      authDomain: "marketing-1e96e.firebaseapp.com",
      databaseURL: "https://marketing-1e96e-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "marketing-1e96e",
      storageBucket: "marketing-1e96e.firebasestorage.app",
      messagingSenderId: "882227172037",
      appId: "1:882227172037:web:6d4a002d7a68c7858896ac"
    };

    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getDatabase, ref, onValue, onDisconnect, serverTimestamp as rtdbTs, set, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Ï¥àÍ∏∞Ìôî
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);

    // ÏÉÅÏàò/Ï∞∏Ï°∞
    const ROOM_ID = "open-room-1";
    const messagesRef = collection(db, `rooms/${ROOM_ID}/messages`);

    // DOM
    const $messages = document.getElementById("messages");
    const $form = document.getElementById("chatForm");
    const $text = document.getElementById("text");
    const $name = document.getElementById("name");
    const $saveName = document.getElementById("saveName");
    const $presence = document.getElementById("presence");
    const $presenceText = document.getElementById("presenceText");
    const $errorMessage = document.getElementById("errorMessage");
    const $sendButton = document.getElementById("sendButton");
    const $file = document.getElementById("file");
    const $attachBtn = document.getElementById("attachBtn");
    const $attachBtn2 = document.getElementById("attachBtn2");
    const $dropZone = document.getElementById("dropZone");
    const $themeToggle = document.getElementById("themeToggle");

    let currentUid = null;
    let lastMessageTime = 0;
    const MESSAGE_COOLDOWN = 1000;

    // ===== Theme =====
    const savedTheme = localStorage.getItem("theme") || "light";
    document.documentElement.setAttribute("data-theme", savedTheme);
    updateThemeIcon(savedTheme);
    $themeToggle.addEventListener("click", () => {
      const now = document.documentElement.getAttribute("data-theme") === "light" ? "dark" : "light";
      document.documentElement.setAttribute("data-theme", now);
      localStorage.setItem("theme", now);
      updateThemeIcon(now);
    });
    function updateThemeIcon(theme){
      const sun = document.getElementById("sun");
      const moon = document.getElementById("moon");
      if (theme === "dark") { sun.style.display="none"; moon.style.display="inline"; }
      else { sun.style.display="inline"; moon.style.display="none"; }
    }

    // ===== Ïú†Ìã∏ =====
    function showError(msg){ $errorMessage.textContent = msg; $errorMessage.style.display='block'; setTimeout(()=>{$errorMessage.style.display='none'}, 4500); }
    const savedName = localStorage.getItem('chatName'); if (savedName) $name.value = savedName;
    function esc(s=""){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
    function linkify(text){ return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener" class="file-link">$1</a>'); }
    function formatBytes(n){ if(n==null) return ""; const u=['B','KB','MB','GB']; let i=0, v=n; while(v>=1024&&i<u.length-1){v/=1024;i++} return (i?v.toFixed(2):v)+' '+u[i]; }
    function initials(name){ const t=(name||"").trim(); if(!t) return "U"; const parts=t.split(/\s+/); return (parts[0][0]||"U").toUpperCase(); }

    // ===== Ïù∏Ï¶ù + ÌîÑÎ†àÏ¶åÏä§ =====
    signInAnonymously(auth).catch(e=> showError('Î°úÍ∑∏Ïù∏ Ïã§Ìå®: '+e.message));

    const ready = { authed:false, connected:false, registered:false };
    onAuthStateChanged(auth, (user) => {
      ready.authed = !!user;
      if (user) currentUid = user.uid;
      tryRegisterPresence();
      // UI show
      document.querySelector(".wrap").style.display="block";
    });

    const connectedRef = ref(rtdb, ".info/connected");
    onValue(connectedRef, (snap) => { ready.connected = snap.val() === true; tryRegisterPresence(); });

    function tryRegisterPresence(){
      if (!ready.authed || !ready.connected || ready.registered || !auth.currentUser) return;
      ready.registered = true;
      const meRef = ref(rtdb, `presence/${ROOM_ID}/${auth.currentUser.uid}`);
      onDisconnect(meRef).remove().catch(()=>{});
      set(meRef, { uid: auth.currentUser.uid, name: $name.value || "ÏùµÎ™Ö", online:true, lastSeen: rtdbTs() }).catch(err => { ready.registered=false; console.error(err); });
    }

    // Ï†ëÏÜçÏûê Ïàò
    onValue(ref(rtdb, `presence/${ROOM_ID}`), (snap) => {
      const val = snap.val() || {};
      const count = Object.keys(val).length;
      $presenceText.textContent = `Ï†ëÏÜçÏûê ${count}Î™Ö`;
    });

    // ÎãâÎÑ§ÏûÑ Ï†ÄÏû•
    $saveName.addEventListener("click", async () => {
      const nickname = ($name.value || "").trim();
      if (!nickname) return showError("ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
      if (nickname.length > 20) return showError("ÎãâÎÑ§ÏûÑÏùÄ 20Ïûê Ïù¥ÎÇ¥Î°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
      $saveName.disabled = true;
      try{
        if (auth.currentUser) {
          await updateProfile(auth.currentUser, { displayName: nickname });
          localStorage.setItem("chatName", nickname);
          const meRef = ref(rtdb, `presence/${ROOM_ID}/${auth.currentUser.uid}`);
          await set(meRef, { uid: auth.currentUser.uid, name: nickname, online:true, lastSeen: rtdbTs() });
          showError("‚úÖ ÎãâÎÑ§ÏûÑÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!");
        }
      }catch(e){ showError("ÎãâÎÑ§ÏûÑ Ï†ÄÏû• Ïã§Ìå®: " + e.message); }
      finally{ $saveName.disabled = false; }
    });

    // Î©îÏãúÏßÄ ÏàòÏã†
    const q = query(messagesRef, orderBy("ts","desc"), limit(50));
    onSnapshot(q, (snap) => {
      const arr = [];
      snap.forEach(doc => {
        const m = doc.data();
        const isMe = m.uid === currentUid;
        const ts = m.ts?.toDate?.() ? new Date(m.ts.toDate()) : null;
        const timeStr = ts ? new Intl.DateTimeFormat('ko-KR',{hour:'2-digit',minute:'2-digit'}).format(ts) : '';

        let bodyHtml = "";
        if (m.type === "file" && m.fileUrl) {
          const size = m.fileSize ? ` <span class="muted">(${formatBytes(m.fileSize)})</span>` : "";
          bodyHtml = `
            <div class="bubble">
              <div class="file-card">
                <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>
                <div>
                  <div><a href="${m.fileUrl}" target="_blank" rel="noopener" class="file-link" download>${esc(m.fileName || "ÌååÏùº Îã§Ïö¥Î°úÎìú")}</a>${size}</div>
                  <div class="file-actions muted">ÏÉà ÌÉ≠ÏóêÏÑú Ïó¥Í∏∞ ¬∑ Ï†ÄÏû•</div>
                </div>
              </div>
            </div>`;
        } else {
          bodyHtml = `<div class="bubble">${linkify(esc(m.text || ""))}</div>`;
        }

        arr.push(`
          <div class="msg ${isMe ? "me" : ""}">
            ${isMe ? "" : `<div class="avatar" title="${esc(m.name||"ÏùµÎ™Ö")}">${esc(initials(m.name||"ÏùµÎ™Ö"))}</div>`}
            <div class="msg-content">
              <div class="meta">${esc(m.name || "ÏùµÎ™Ö")} ¬∑ ${timeStr}</div>
              ${bodyHtml}
            </div>
            ${isMe ? `<div class="avatar" title="${esc(m.name||"ÎÇò")}">${esc(initials(m.name||"ÎÇò"))}</div>` : ""}
          </div>
        `);
      });
      $messages.innerHTML = arr.reverse().join("");
      $messages.scrollTop = $messages.scrollHeight;
    }, (err)=> showError('Î©îÏãúÏßÄ Î°úÎìú Ïã§Ìå®: '+err.message));

    // Î©îÏãúÏßÄ Ï†ÑÏÜ°
    $form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = ($text.value || "").trim();
      const nickname = ($name.value || "ÏùµÎ™Ö").trim();
      if (!text) return;
      const now = Date.now();
      if (now - lastMessageTime < 1000) return showError("Î©îÏãúÏßÄ Ï†ÑÏÜ°Ïù¥ ÎÑàÎ¨¥ Îπ†Î¶ÖÎãàÎã§.");
      if (text.length > 500) return showError("Î©îÏãúÏßÄÎäî 500Ïûê Ïù¥ÎÇ¥Î°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");

      $sendButton.disabled = true; $text.disabled = true;
      try{
        await addDoc(messagesRef, { uid: currentUid, name: nickname || "ÏùµÎ™Ö", text, ts: serverTimestamp() });
        $text.value = ""; lastMessageTime = now;
      }catch(err){ showError("Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®: " + err.message); }
      finally{ $sendButton.disabled = false; $text.disabled = false; $text.focus(); }
    });

    // Îñ†ÎÇ† Îïå presence Ï†ïÎ¶¨
    window.addEventListener('beforeunload', () => { if (currentUid) remove(ref(rtdb, `presence/${ROOM_ID}/${currentUid}`)); });
    document.addEventListener('visibilitychange', () => {
      if (!currentUid) return;
      const meRef = ref(rtdb, `presence/${ROOM_ID}/${currentUid}`);
      set(meRef, { uid: currentUid, name: $name.value || "ÏùµÎ™Ö", online: !document.hidden, lastSeen: rtdbTs() });
    });

    // ===== ÌååÏùº ÏóÖÎ°úÎìú (Supabase Edge Function ÏÇ¨Ïö©) =====
    const EDGE_UPLOAD_URL = "https://qcqxomdqemjqhykxrugf.supabase.co/functions/v1/upload";

    $attachBtn.addEventListener("click", ()=> $file.click());
    $attachBtn2.addEventListener("click", ()=> $file.click());

    // Drag & Drop
    window.addEventListener("dragover", (e)=>{ e.preventDefault(); $dropZone.classList.add("show"); });
    window.addEventListener("dragleave", (e)=>{ $dropZone.classList.remove("show"); });
    window.addEventListener("drop", (e)=>{
      e.preventDefault(); $dropZone.classList.remove("show");
      const f = e.dataTransfer?.files?.[0]; if (f) handleFileUpload(f);
    });

    $file.addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      handleFileUpload(f);
      e.target.value = ""; // reset
    });

    async function handleFileUpload(f){
      // .html fail-to-fetch ÌöåÌîº: ÏïàÏ†Ñ MIMEÏúºÎ°ú Ï†ÑÏÜ°
      const ext = (f.name.split(".").pop() || "").toLowerCase();
      let uploadFile = f;
      if (ext === "html" || ext === "htm") {
        uploadFile = new File([f], f.name, { type: "application/octet-stream" });
      } else if (ext === "py" && (!f.type || f.type === "")) {
        uploadFile = new File([f], f.name, { type: "text/plain" });
      }

      let url;
      try {
        const fd = new FormData();
        fd.append("file", uploadFile);
        const res = await fetch(`${EDGE_UPLOAD_URL}?room=${ROOM_ID}`, { method: "POST", body: fd });
        if (!res.ok) {
          const t = await res.text().catch(()=> "");
          throw new Error(`ÏóÖÎ°úÎìú Ìï®Ïàò Ìò∏Ï∂ú Ïã§Ìå®: ${res.status} ${res.statusText} ${t}`);
        }
        const json = await res.json();
        url = json?.url;
        if (!url) throw new Error("ÏóÖÎ°úÎìúÎäî ÏÑ±Í≥µÌñàÏßÄÎßå URLÏù¥ ÏóÜÏäµÎãàÎã§.");
      } catch (err) {
        console.error("[upload] Ïã§Ìå®:", err);
        showError("ÏóÖÎ°úÎìú Ïã§Ìå®: " + (err?.message || err));
        return;
      }

      try {
        await addDoc(messagesRef, {
          uid: currentUid,
          name: ($name.value || "ÏùµÎ™Ö").slice(0, 24),
          type: "file",
          fileName: f.name,     // ÏõêÎûò ÌååÏùºÎ™Ö ÌëúÏãú
          fileSize: f.size,
          fileUrl: url,
          ts: serverTimestamp()
        });
      } catch (err) {
        console.error("[firestore] Î©îÏãúÏßÄ Í∏∞Î°ù Ïã§Ìå®:", err);
        showError("Î©îÏãúÏßÄ Í∏∞Î°ù Ïã§Ìå®(Í∂åÌïú?): " + (err?.message || err));
      }
    }
  </script>
</body>
</html>
