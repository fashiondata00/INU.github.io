<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Data marketing (Made by. Fashiondata00 Lab)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f7f8fa; min-height:100vh; padding:20px; }
    .wrap { max-width:800px; margin:0 auto; animation:fadeIn .5s ease-in; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
    .card { background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 2px 20px rgba(0,0,0,.08); height:85vh; display:flex; flex-direction:column; border:1px solid #e5e7eb; }
    header { background:#fff; color:#1f2937; padding:20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #e5e7eb; }
    header h3 { font-size:1.4rem; font-weight:600; color:#111827; }
    #presence { background:#f3f4f6; padding:8px 16px; border-radius:20px; font-size:.9rem; color:#6b7280; display:flex; align-items:center; gap:8px; }
    .user-section { padding:15px 20px; background:#fafbfc; border-bottom:1px solid #e5e7eb; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    #name { flex:1; min-width:200px; padding:10px 15px; border:1px solid #d1d5db; border-radius:8px; font-size:15px; transition:.3s; background:#fff; }
    #name:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    #saveName { padding:10px 20px; background:#3b82f6; color:#fff; border:none; border-radius:8px; font-weight:500; cursor:pointer; transition:.3s; }
    #saveName:hover { background:#2563eb; box-shadow:0 2px 8px rgba(59,130,246,.3); }
    #saveName:disabled { opacity:.5; cursor:not-allowed; }
    .status-indicator { width:8px; height:8px; background:#10b981; border-radius:50%; animation:pulse 2s infinite; display:inline-block; }
    @keyframes pulse { 0%,100%{opacity:1; transform:scale(1)} 50%{opacity:.8; transform:scale(1.2)} }
    #messages { flex:1; overflow-y:auto; padding:20px; background:#fafbfc; }
    #messages::-webkit-scrollbar{width:6px} #messages::-webkit-scrollbar-track{background:#f3f4f6; border-radius:10px} #messages::-webkit-scrollbar-thumb{background:#d1d5db; border-radius:10px} #messages::-webkit-scrollbar-thumb:hover{background:#9ca3af}
    .msg{ margin:12px 0; display:flex; animation:slideIn .3s ease-out; }
    @keyframes slideIn{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
    .msg.me{ justify-content:flex-end; }
    .msg-content{ max-width:70%; }
    .msg .meta{ font-size:12px; color:#9ca3af; margin-bottom:4px; padding:0 8px; }
    .msg.me .meta{ text-align:right; }
    .msg .bubble{ background:#fff; padding:10px 14px; border-radius:16px; box-shadow:0 1px 3px rgba(0,0,0,.08); word-wrap:break-word; border:1px solid #e5e7eb; color:#1f2937; }
    .msg.me .bubble{ background:#3b82f6; color:#fff; border:none; }
    .file-link{ text-decoration:underline; }
    .chat-form{ padding:16px 20px; background:#fff; border-top:1px solid #e5e7eb; display:flex; gap:10px; }
    #text{ flex:1; padding:10px 16px; border:1px solid #d1d5db; border-radius:24px; font-size:15px; transition:.3s; background:#f9fafb; }
    #text:focus{ outline:none; border-color:#3b82f6; background:#fff; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    .send-button{ padding:10px 20px; background:#3b82f6; color:#fff; border:none; border-radius:24px; font-weight:500; cursor:pointer; transition:.3s; display:flex; align-items:center; gap:6px; }
    .send-button:hover:not(:disabled){ background:#2563eb; box-shadow:0 2px 8px rgba(59,130,246,.3); }
    .send-button:disabled{ opacity:.5; cursor:not-allowed; background:#9ca3af; }
    .loading{ position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; background:#fff; padding:40px; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.1); z-index:9999; }
    .spinner{ width:50px; height:50px; border:3px solid #e5e7eb; border-top-color:#3b82f6; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 20px; }
    @keyframes spin{ to{transform:rotate(360deg)} }
    .loading-text{ color:#6b7280; font-size:16px; margin-bottom:10px; }
    .connection-status{ color:#9ca3af; font-size:14px; }
    .error-message{ background:#fef2f2; color:#dc2626; padding:12px 16px; border-radius:8px; margin:10px 20px; display:none; border:1px solid #fecaca; font-size:14px; }
    .user-count{ font-weight:600; color:#374151; }
    .file-input { padding:8px 12px; border:1px solid #d1d5db; border-radius:8px; background:#fff; }
    @media (max-width:600px){ .card{ height:90vh; border-radius:0; border:none } .wrap{ padding:0 } body{ padding:0 } .msg-content{ max-width:85% } header h3{ font-size:1.2rem } .user-section{ flex-direction:column } #name,#saveName{ width:100% } }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div class="loading-text">Ï±ÑÌåÖÎ∞© Ïó∞Í≤∞ Ï§ë...</div>
    <div class="connection-status" id="connectionStatus"></div>
  </div>

  <div class="wrap" style="display:none" id="app">
    <div class="card">
      <header>
        <h3>üí¨ Ïò§Ìîà Ï±ÑÌåÖÎ∞©</h3>
        <div id="presence">
          <span class="user-count">Ï†ëÏÜçÏûê 0Î™Ö</span>
          <span class="status-indicator"></span>
        </div>
      </header>

      <div class="user-section">
        <input id="name" placeholder="ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="20" />
        <button id="saveName">Ï†ÄÏû•</button>
        <!-- ‚úÖ ÌååÏùº ÏóÖÎ°úÎìú ÏûÖÎ†• (py/html Ìè¨Ìï®) -->
        <input id="file" class="file-input" type="file"
               accept=".xlsx,.xls,.doc,.docx,.pdf,.csv,.py,.html,.htm,.txt" />
      </div>

      <div class="error-message" id="errorMessage"></div>
      <div id="messages"></div>

      <form class="chat-form" id="chatForm">
        <input id="text" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." maxlength="500" autocomplete="off" />
        <button type="submit" class="send-button" id="sendButton">
          <span>Ï†ÑÏÜ°</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </form>
    </div>
  </div>

  <!-- Firebase SDK + Ïï± ÏΩîÎìú -->
  <script type="module">
    // ===== Firebase ÏÑ§Ï†ï =====
    const firebaseConfig = {
      apiKey: "AIzaSyB3Vf5qeWKdWPFrBddnEczXdtzv2Iw8peQ",
      authDomain: "marketing-1e96e.firebaseapp.com",
      databaseURL: "https://marketing-1e96e-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "marketing-1e96e",
      storageBucket: "marketing-1e96e.firebasestorage.app",
      messagingSenderId: "882227172037",
      appId: "1:882227172037:web:6d4a002d7a68c7858896ac"
    };

    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getDatabase, ref, onValue, onDisconnect, serverTimestamp as rtdbTs, set, remove
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Ï¥àÍ∏∞Ìôî
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);

    // ÏÉÅÏàò/Ï∞∏Ï°∞
    const ROOM_ID = "open-room-1";
    const messagesRef = collection(db, `rooms/${ROOM_ID}/messages`);

    // DOM
    const $loading = document.getElementById("loading");
    const $app = document.getElementById("app");
    const $messages = document.getElementById("messages");
    const $form = document.getElementById("chatForm");
    const $text = document.getElementById("text");
    const $name = document.getElementById("name");
    const $saveName = document.getElementById("saveName");
    const $presence = document.getElementById("presence");
    const $errorMessage = document.getElementById("errorMessage");
    const $sendButton = document.getElementById("sendButton");
    const $connectionStatus = document.getElementById("connectionStatus");
    const $file = document.getElementById("file");

    let currentUid = null;
    let lastMessageTime = 0;
    const MESSAGE_COOLDOWN = 1000;

    // Ïú†Ìã∏
    function showError(msg){ $errorMessage.textContent = msg; $errorMessage.style.display='block'; setTimeout(()=>{$errorMessage.style.display='none'}, 5000); }
    const savedName = localStorage.getItem('chatName'); if (savedName) $name.value = savedName;
    function esc(s=""){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
    function linkify(text){ return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer" class="file-link">$1</a>'); }
    function formatBytes(n){ if(!n&&n!==0) return ""; const u=['B','KB','MB','GB']; let i=0; let v=n; while(v>=1024&&i<u.length-1){v/=1024;i++} return (i?v.toFixed(2):v)+' '+u[i]; }

    // ===== Ïù∏Ï¶ù + ÌîÑÎ†àÏ¶åÏä§(.info/connected) =====
    signInAnonymously(auth).catch(e=>{ showError('Î°úÍ∑∏Ïù∏ Ïã§Ìå®: '+e.message); $connectionStatus.textContent='Î°úÍ∑∏Ïù∏ Ïã§Ìå®'; });

    const ready = { authed:false, connected:false, registered:false };
    onAuthStateChanged(auth, (user) => {
      ready.authed = !!user;
      if (user) currentUid = user.uid;
      tryRegisterPresence();
      // UI ÌëúÏãú
      if (user) { $loading.style.display='none'; $app.style.display='block'; }
    });

    const connectedRef = ref(rtdb, ".info/connected");
    onValue(connectedRef, (snap) => {
      ready.connected = snap.val() === true;
      tryRegisterPresence();
    });

    function tryRegisterPresence(){
      if (!ready.authed || !ready.connected || ready.registered || !auth.currentUser) return;
      ready.registered = true;
      const meRef = ref(rtdb, `presence/${ROOM_ID}/${auth.currentUser.uid}`);
      onDisconnect(meRef).remove().catch(()=>{});
      set(meRef, { uid: auth.currentUser.uid, name: $name.value || "ÏùµÎ™Ö", online:true, lastSeen: rtdbTs() })
        .catch(err => { ready.registered=false; console.error(err); });
    }

    // Ï†ëÏÜçÏûê Ïàò
    const presenceRef = ref(rtdb, `presence/${ROOM_ID}`);
    onValue(presenceRef, (snap) => {
      const val = snap.val() || {};
      const count = Object.keys(val).length; // onDisconnectÎ°ú Ï†ïÎ¶¨ÎêòÎØÄÎ°ú online ÌîåÎûòÍ∑∏ Ï≤¥ÌÅ¨ Î∂àÌïÑÏöî
      $presence.innerHTML = `<span class="user-count">Ï†ëÏÜçÏûê ${count}Î™Ö</span><span class="status-indicator"></span>`;
    });

    // ÎãâÎÑ§ÏûÑ Ï†ÄÏû•
    $saveName.addEventListener("click", async () => {
      const nickname = ($name.value || "").trim();
      if (!nickname) return showError("ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
      if (nickname.length > 20) return showError("ÎãâÎÑ§ÏûÑÏùÄ 20Ïûê Ïù¥ÎÇ¥Î°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
      $saveName.disabled = true;
      try{
        if (auth.currentUser) {
          await updateProfile(auth.currentUser, { displayName: nickname });
          localStorage.setItem("chatName", nickname);
          const meRef = ref(rtdb, `presence/${ROOM_ID}/${auth.currentUser.uid}`);
          await set(meRef, { uid: auth.currentUser.uid, name: nickname, online:true, lastSeen: rtdbTs() });
          showError("‚úÖ ÎãâÎÑ§ÏûÑÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!");
        }
      }catch(e){ showError("ÎãâÎÑ§ÏûÑ Ï†ÄÏû• Ïã§Ìå®: " + e.message); }
      finally{ $saveName.disabled = false; }
    });

    // Î©îÏãúÏßÄ ÏàòÏã†
    const q = query(messagesRef, orderBy("ts","desc"), limit(50));
    onSnapshot(q, (snap) => {
      const arr = [];
      snap.forEach(doc => {
        const m = doc.data();
        const isMe = m.uid === currentUid;
        const ts = m.ts?.toDate?.() ? new Date(m.ts.toDate()) : null;
        const timeStr = ts ? new Intl.DateTimeFormat('ko-KR',{hour:'2-digit',minute:'2-digit'}).format(ts) : '';

        let bodyHtml = "";
        if (m.type === "file" && m.fileUrl) {
          const size = m.fileSize ? ` <span style="color:#9ca3af">(${formatBytes(m.fileSize)})</span>` : "";
          bodyHtml = `<div class="bubble">üìé <a href="${m.fileUrl}" target="_blank" rel="noopener" class="file-link" download>${esc(m.fileName || "ÌååÏùº Îã§Ïö¥Î°úÎìú")}</a>${size}</div>`;
        } else {
          bodyHtml = `<div class="bubble">${linkify(esc(m.text || ""))}</div>`;
        }

        arr.push(`
          <div class="msg ${isMe ? "me" : ""}">
            <div class="msg-content">
              <div class="meta">${esc(m.name || "ÏùµÎ™Ö")} ¬∑ ${timeStr}</div>
              ${bodyHtml}
            </div>
          </div>
        `);
      });
      $messages.innerHTML = arr.reverse().join("");
      $messages.scrollTop = $messages.scrollHeight;
    }, (err)=> showError('Î©îÏãúÏßÄ Î°úÎìú Ïã§Ìå®: '+err.message));

    // Î©îÏãúÏßÄ Ï†ÑÏÜ°
    $form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = ($text.value || "").trim();
      const nickname = ($name.value || "ÏùµÎ™Ö").trim();
      if (!text) return;
      const now = Date.now();
      if (now - lastMessageTime < MESSAGE_COOLDOWN) return showError("Î©îÏãúÏßÄ Ï†ÑÏÜ°Ïù¥ ÎÑàÎ¨¥ Îπ†Î¶ÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
      if (text.length > 500) return showError("Î©îÏãúÏßÄÎäî 500Ïûê Ïù¥ÎÇ¥Î°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");

      $sendButton.disabled = true; $text.disabled = true;
      try{
        await addDoc(messagesRef, { uid: currentUid, name: nickname || "ÏùµÎ™Ö", text, ts: serverTimestamp() });
        $text.value = ""; lastMessageTime = now;
      }catch(err){ showError("Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®: " + err.message); }
      finally{ $sendButton.disabled = false; $text.disabled = false; $text.focus(); }
    });

    // Ïñ∏Î°úÎìú/Í∞ÄÏãúÏÑ±
    window.addEventListener('beforeunload', () => { if (currentUid) remove(ref(rtdb, `presence/${ROOM_ID}/${currentUid}`)); });
    document.addEventListener('visibilitychange', () => {
      if (!currentUid) return;
      const meRef = ref(rtdb, `presence/${ROOM_ID}/${currentUid}`);
      set(meRef, { uid: currentUid, name: $name.value || "ÏùµÎ™Ö", online: !document.hidden, lastSeen: rtdbTs() });
    });

    // ===== ÌååÏùº ÏóÖÎ°úÎìú (Supabase Edge Function ÏÇ¨Ïö©) =====
    // ÎãπÏã†Ïù¥ Ï§Ä Ìï®Ïàò URL
    const EDGE_UPLOAD_URL = "https://qcqxomdqemjqhykxrugf.supabase.co/functions/v1/upload";

    $file?.addEventListener("change", async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;

      try{
        const fd = new FormData();
        fd.append("file", f);
        const res = await fetch(`${EDGE_UPLOAD_URL}?room=${ROOM_ID}`, { method:"POST", body:fd });
        if (!res.ok) throw new Error(await res.text());
        const { url } = await res.json();

        await addDoc(messagesRef, {
          uid: currentUid,
          name: ($name.value || "ÏùµÎ™Ö").slice(0,24),
          type: "file",
          fileName: f.name,
          fileSize: f.size,
          fileUrl: url,
          ts: serverTimestamp()
        });

        e.target.value = "";
      }catch(err){
        console.error(err);
        showError("ÌååÏùº ÏóÖÎ°úÎìú Ïã§Ìå®: " + (err?.message || err));
      }
    });
  </script>
</body>
</html>
